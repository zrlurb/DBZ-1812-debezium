# Benchmark

The E2E benchmark is a pyton script which fill a special database table with data. One column is a timestap by insert into the table. The test compare this time with the time of the correspondig timestamp of the kafka massage in the topic. It create in the tpcdata directory the result csv and some png diagrams.

in the tpc-config.json are all function SQL stored in it.

The control of how many test and commit controll could you set in this part of the json:
```
"tpc": {
        "count": 100000,
        "commit.intervals": [
            1,
            100,
            1000,
            10000
        ]
    },
```
count of rows of the test. 
commit.intervals array reflect row per interval, every entry run one benchmark test.

Think about the parameter commit.intervals, set it not to high. The benchmark should help to compare it. 


## Benchmark by existing environment (DB Server / Kafka / Connector)

If you have an exist up und running debeyium environment, you can do the benchmark test by following steps. 

- build the benchmark docker    
``` docker build -t debezium-benchmark  . ```
- run the docker   
``` docker -itd --name benckmark  debezium-benchmark -v <result path>:/home/tpc/tpcdata```
- create the table in your database
    - SQL create table for db2    
``` CREATE TABLE TPC.TEST ( USERNAME VARCHAR(32) NOT NULL, NAME VARCHAR(64), BLOOD_GROUP CHAR(3), RESIDENCE VARCHAR(200), COMPANY VARCHAR(128), ADDRESS VARCHAR(200), BIRTHDATE DATE, SEX CHAR(1), JOB VARCHAR(128), SSN CHAR(11), MAIL VARCHAR(128), ID INTEGER not null GENERATED ALWAYS AS IDENTITY (START WITH 1 INCREMENT BY 1), T0 TIMESTAMP NOT NULL     GENERATED BY DEFAULT     FOR EACH ROW ON UPDATE AS ROW CHANGE TIMESTAMP, PRIMARY KEY (ID) ) ORGANIZE BY ROW ```    
    - SQL create table for SQLServer   
``` CREATE TABLE TPC.TEST ( USERNAME VARCHAR(32) NOT NULL, NAME VARCHAR(64), BLOOD_GROUP CHAR(3), RESIDENCE VARCHAR(200), COMPANY VARCHAR(128), ADDRESS VARCHAR(200), BIRTHDATE DATE, SEX CHAR(1), JOB VARCHAR(128), SSN CHAR(11), MAIL VARCHAR(128), ID INT IDENTITY(1,1) PRIMARY KEY, T0 TIMESTAMP DATETIME NULL DEFAULT GETDATE() ) ``` 
    - SQL crete table for MySQL   
``` CREATE TABLE TPC.TEST ( USERNAME VARCHAR(32) NOT NULL, NAME VARCHAR(64), BLOOD_GROUP CHAR(3), RESIDENCE VARCHAR(200), COMPANY VARCHAR(128), ADDRESS VARCHAR(200), BIRTHDATE DATE, SEX CHAR(1), JOB VARCHAR(128), SSN CHAR(11), MAIL VARCHAR(128), ID INTEGER NOT NULL AUTO_INCREMENT, T0 TIMESTAMP  DEFAULT CURRENT_TIMESTAMP ) ``` 

- whitelist the TPC.TEST table in your connector config jason
```  "database.whitelist" : "TPC.TEST"   ```

- enable the table for CDC on the database
    - SQL for db2    
        - ``` CALL ASNCDC.ADDTABLE('TPC','TEST') ```
        - ``` UPDATE ASNCDC.IBMSNAP_CAPPARMS SET COMMIT_INTERVAL=1 , SLEEP_INTERVAL=1 ```  
        - ``` VALUES ASNCDC.ASNCDCSERVICES('reinit','asncdc') ```
        - ``` VALUES ASNCDC.ASNCDCSERVICES('status','asncdc') ``` 
    - SQL for SQLServer    
``` for detail see debezium-sqlserver-connector ```
    - SQL for MySQL   
```  for detail see debezium-mysql-connector ```

- login to the docker
``` docker exec -it benchmark /bin/bash ```
- copy the debezium-config jason in the home directory as /home/tpc/register.json
- go to the python directory 
``` cd /home/tpc/py ```
- edit the tpc-config.json to add the correct debezium.connect.server FQDN:port 
- now run the tests 
``` python3 tpc-run-tes.py ```
- create plots
``` python3 runplots.py ```




## Benchmark debezium-example environment

Run benchmark in one docker environment CENTOS

### Build CENTOS environment

```
yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
yum update
yum -y install wget
yum -y install docker
yum -y install docker-compose
yum -y install maven
yum -y install git
```

## Compose DOCKER from debezium-excample

create volume directories and compose
```
mkdir /home/<user name>/dockerdata
cd /home/<user name>
git clone https://github.com/debezium/debezium-examples
cd /home/<user name>/debezium-examples/tutorial
export DEBEZIUM_VERSION=1.1  
export DEBEZIUM_DB2_VOLUME=/home/<user name>/dockerdata

docker-compose -f docker-compose-db2.yaml build

```


## run TPC debezium docker


```
cd /home/<user name>
mkdir tpcdata
chmod 777 /home/<user name>/tpcdata
export DEBEZIUM_TPC_VOLUME=/home/<user name>/tpcdata
git clone https://github.com/debezium/debezium
cd debezium/debezium-e2e-benchmark
# if you like do do it with an other db, adapt the docker-compose file from your prefered database and update the tpc-config.json file for appropriate database ( SQL)
docker-compose -f docker-compose-db2-tpc.yaml up --build
```
## KAFKA change for topic deletion

```
docker exec -it debeziumtpc_kafka_1 /bin/bash
cd /kafka
echo 'delete.topic.enable=true' >> /kafka/config/server.properties 
exit
docker stop debeziumtpc_kafka_1
docker start debeziumtpc_kafka_1
```

# run test and plots
```
docker exec -it debeziumtpc_tpc_1 /bin/bash
python3 tpc-run-test.py 
python3 runplots.py 
```
the results are in the DEBEZIUM_TPC_VOLUME


## TIPS
``` 
 /kafka/bin/kafka-topics.sh --bootstrap-server <FQDN bootstrap server>:9092 --list
 /kafka/bin/kafka-topics.sh --bootstrap-server <FQDN bootstrap server>:9092 --topic TESTDB.DB2INST1.CUSTOMERS --delete
 /kafka/bin/kafka-console-consumer.sh --bootstrap-server <FQDN bootstrap server>:9092 --topic CPRODUCER --from-beginning --property print.key=true  --property print.timestamp=true
```
